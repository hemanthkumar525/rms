{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Submit{% endif %} Maintenance Request - RMS{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow border-0 rounded-4">
            <div class="card-header bg-primary text-white py-3 rounded-top-4">
                <h4 class="mb-0">{% if form.instance.pk %}Edit{% else %}Submit{% endif %} Maintenance Request</h4>
            </div>
            <div class="card-body p-4">
                {% if messages %}
                    <div class="messages mb-4">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <!-- Property and Unit Information -->
                    <div class="mb-4">
                        <h5 class="mb-3">Property Details</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Property:</strong> {{ property.title }}</p>
                                <p class="mb-2"><strong>Address:</strong> {{ property.address }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Unit:</strong> {{ unit.unit_number }}</p>
                                <p class="mb-2"><strong>Tenant:</strong> {{ request.user.get_full_name }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Request Images Section -->
                    <div class="mb-4">
                        <h5 class="mb-3">Request Images</h5>
                        <div class="image-upload-container">
                            <div class="image-upload-area" id="dropZone">
                                <input type="file" name="images" id="id_images" multiple accept="image/*" class="d-none">
                                <div class="text-center py-5">
                                    <i class="fas fa-cloud-upload-alt mb-3" style="font-size: 2.5rem; color: #0d6efd;"></i>
                                    <h6 class="mb-2">Drag and drop images here</h6>
                                    <p class="text-muted small mb-3">or</p>
                                    <button type="button" class="btn btn-outline-primary btn-sm px-4" onclick="document.getElementById('id_images').click()">
                                        Browse Files
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Image Preview Container -->
                            <div class="image-preview mt-4" id="image-preview">
                                <div class="row g-3" id="preview-row">
                                    {% if images %}
                                        {% for image in images %}
                                            <div class="col-6 col-md-4 col-lg-3">
                                                <div class="image-preview-item">
                                                    <img src="{{ image.image.url }}" alt="Request Image" class="img-fluid rounded">
                                                    <button type="button" class="btn-remove" data-image-id="{{ image.id }}">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Request Details -->
                    <div class="mb-4">
                        <h5 class="mb-3">Request Details</h5>
                        {{ form|crispy }}
                    </div>

                    <div class="d-flex justify-content-end">
                        <a href="{% url 'properties:maintenance_request_list' %}" class="btn btn-light px-4 py-2">
                            <i class="fas fa-arrow-left me-2"></i>Back to List
                        </a>
                        <button type="submit" class="btn btn-primary px-4 py-2 ms-2">
                            <i class="fas fa-paper-plane me-2"></i>{% if form.instance.pk %}Update{% else %}Submit{% endif %} Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block style %}
<style>
    .image-upload-container {
        width: 100%;
    }
    
    .image-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .image-upload-area.dragover {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    .image-preview-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .image-preview-item img {
        width: 100%;
        height: 160px;
        object-fit: cover;
    }
    
    .btn-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255,255,255,0.9);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #dc3545;
        transition: all 0.2s ease;
    }
    
    .btn-remove:hover {
        background: #dc3545;
        color: white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('id_images');
    const previewRow = document.getElementById('preview-row');
    
    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
        dropZone.classList.add('dragover');
    }
    
    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }
    
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    imageInput.addEventListener('change', function() {
        handleFiles(this.files);
    });
    
    function handleFiles(files) {
        [...files].forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';
                    col.innerHTML = `
                        <div class="image-preview-item">
                            <img src="${e.target.result}" alt="Request Image" class="img-fluid rounded">
                            <button type="button" class="btn-remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    previewRow.appendChild(col);
                    
                    // Add remove functionality
                    col.querySelector('.btn-remove').addEventListener('click', function() {
                        col.remove();
                    });
                }
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Remove existing images
    document.querySelectorAll('.btn-remove[data-image-id]').forEach(btn => {
        btn.addEventListener('click', function() {
            const imageId = this.dataset.imageId;
            if (confirm('Are you sure you want to remove this image?')) {
                // Add hidden input to track deleted images
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'deleted_images';
                input.value = imageId;
                document.querySelector('form').appendChild(input);
                this.closest('.col-6').remove();
            }
        });
    });
});
</script>
{% endblock %}